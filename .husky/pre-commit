set -e  # Exit immediately if a command exits with a non-zero status
echo "[pre-commit] Starting pre-commit hook..."

# Verify HEAD
echo "[pre-commit] Checking if HEAD exists..."
if git rev-parse --verify HEAD >/dev/null 2>&1; then
    against=HEAD
    echo "[pre-commit] HEAD found. Diffing against HEAD."
else
    against=$(git hash-object -t tree /dev/null)
    echo "[pre-commit] No HEAD found. Using empty tree for diff."
fi

# Check non-ASCII filenames
echo "[pre-commit] Checking for non-ASCII filenames..."
allownonascii=$(git config --type=bool hooks.allownonascii || echo "false")

if [ "$allownonascii" != "true" ] &&
    test $(git diff-index --cached --name-only --diff-filter=A -z "$against" |
      LC_ALL=C tr -d '[ -~]\0' | wc -c) != 0
then
    echo "[pre-commit] ERROR: Non-ASCII filenames detected."
    cat <<\EOF
Error: Attempt to add a non-ASCII file name.

This can cause problems if you want to work with people on other platforms.

To be portable it is advisable to rename the file.

If you know what you are doing you can disable this check using:

  git config hooks.allownonascii true
EOF
    exit 1
else
    echo "[pre-commit] No non-ASCII filenames detected."
fi

# Check for whitespace errors
echo "[pre-commit] Checking for whitespace errors..."
if ! git diff-index --check --cached "$against" --; then
    echo "[pre-commit] ERROR: Whitespace errors detected. Please fix them before committing."
    exit 1
else
    echo "[pre-commit] No whitespace errors detected."
fi

# Find staged C/C++ files
echo "[pre-commit] Finding staged C/C++ files to format..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|hpp|c|h)$' || true)

if [ -n "$STAGED_FILES" ]; then
    echo "[pre-commit] Found staged C/C++ files:"
    echo "$STAGED_FILES"

    echo "[pre-commit] Running clang-format..."
    echo "$STAGED_FILES" | xargs clang-format -i

    echo "[pre-commit] Re-adding formatted files to staging area..."
    echo "$STAGED_FILES" | xargs git add

    echo "[pre-commit] clang-format completed and staged."
else
    echo "[pre-commit] No staged C/C++ files to format."
fi

echo "[pre-commit] Pre-commit hook completed successfully!"
